generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid())

  name   String     @db.VarChar(99)
  email  String     @unique @db.VarChar(99)
  roles  UserRole[]
  avatar String?
  gender Gender

  // Security
  isEmailVerified Boolean      @default(false)
  emailVerifiedAt DateTime?
  provider        AuthProvider @default(DEFAULT)
  password        String?      @db.VarChar(100)
  mfaEnabled      Boolean      @default(false) //multi factor authentication(mfa)
  isLocked        Boolean      @default(false)
  lockedUntil     DateTime?

  // Lifecycle
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  identitySession IdentitySession[]
  oauthConsents   OAuthConsent[]
  oauthClients    OAuthClient[]
}

model IdentitySession {
  token  String @id @db.Char(64)
  userId String

  issuedAt   DateTime  @default(now())
  lastUsedAt DateTime?
  expiresAt  DateTime
  revoked    Boolean   @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revoked, expiresAt])
  @@index([expiresAt])
}

model OAuthClient {
  id String @id @default(uuid())

  // Owner
  userId String

  // App identity
  name   String @db.VarChar(99)
  domain String @db.VarChar(255)

  // Secrets
  clientSecretHash String? @db.VarChar(255)

  // OAuth behavior
  clientType   OAuthClientType        @default(CONFIDENTIAL)
  environment  OAuthClientEnvironment @default(development)
  enforcePKCE  Boolean                @default(true)

  // Redirect URIs
  redirectURIs String[]

  // Status & lifecycle
  isActive  Boolean   @default(true)
  revokedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  oauthConsents OAuthConsent[]

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([domain])
}

// JOSE
model SigningKeys {
  id  String @id @default(uuid())
  kid String @unique

  use       KeyUse
  algorithm KeyAlgorithm

  privateKeyEnc Json
  publicKey     Json

  status KeyStatus

  createdAt DateTime  @default(now())
  rotatedAt DateTime?
  expiresAt DateTime?
}

model OAuthConsent {
  id String @id @default(cuid())

  userId   String
  clientId String

  scopes String[] // approved scopes only

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  revokedAt DateTime?

  user   User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  client OAuthClient @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@unique([userId, clientId])
  @@index([clientId])
}

// User

enum UserRole {
  ADMIN
  USER
  DEVELOPER
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AuthProvider {
  DEFAULT
  GOOGLE
  GITHUB
}

// OAuth Client

enum OAuthClientType {
  PUBLIC
  CONFIDENTIAL
}

enum OAuthClientEnvironment {
  development
  production
}

// Signing Keys 

enum KeyStatus {
  ACTIVE
  RETIRED
  REVOKED
}

enum KeyUse {
  SIG
  ENC
}

enum KeyAlgorithm {
  RS256
  ES256
}
