generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id String @id @default(uuid())

  name   String   @db.VarChar(99)
  email  String   @unique @db.VarChar(99)
  role   UserRole @default(USER)
  avatar String?

  // Security
  isEmailVerified Boolean      @default(false)
  emailVerifiedAt DateTime?
  provider        AuthProvider @default(DEFAULT)
  password        String?      @db.VarChar(100)
  mfaEnabled      Boolean      @default(false) //multi factor authentication(mfa)
  isLocked        Boolean      @default(false)
  lockedUntil     DateTime?

  // Lifecycle
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  identitySession IdentitySession[]
}

model IdentitySession {
  token  String @id @db.Char(64)
  userId String

  issuedAt   DateTime  @default(now())
  lastUsedAt DateTime?
  expiresAt  DateTime
  revoked    Boolean   @default(false)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, revoked, expiresAt])
  @@index([expiresAt])
}

model OAuthClient {
  id     String @id @default(uuid())
  domain String @db.VarChar(255)

  // OAuth identifiers
  clientSecretHash String? @db.VarChar(255)

  // OAuth behavior
  clientType  OAuthClientType @default(CONFIDENTIAL)
  enforcePKCE Boolean         @default(true)

  // Redirect URIs
  redirectURIs String[]

  // Status & lifecycle
  isActive  Boolean   @default(true)
  revokedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([domain])
}

enum UserRole {
  ADMIN
  USER
}

enum AuthProvider {
  DEFAULT
  GOOGLE
  GITHUB
}

enum OAuthClientType {
  PUBLIC
  CONFIDENTIAL
}
